From 8521b9e89e0a6a8480588d0fc27048c64a49320c Mon Sep 17 00:00:00 2001
From: Chunrong Guo <chunrong.guo@nxp.com>
Date: Mon, 6 Jan 2020 02:58:26 +0100
Subject: [PATCH] Enable POLICY_OTA for Layerscape boards

Signed-off-by: Chunrong.guo <chunrong.guo@nxp.com>
---
 arch/arm/cpu/armv8/fsl-layerscape/Kconfig     | 17 ++++++++
 arch/arm/cpu/armv8/fsl-layerscape/cpu.c       |  3 ++
 board/freescale/ls1012afrdm/ls1012afrdm.c     |  2 +-
 board/freescale/ls1012ardb/ls1012ardb.c       |  1 +
 board/freescale/ls1043ardb/ls1043ardb.c       |  2 +-
 board/freescale/ls1046ardb/ls1046ardb.c       |  2 +-
 board/freescale/ls1088a/ls1088a.c             |  2 +-
 board/freescale/ls2080ardb/ls2080ardb.c       |  2 +-
 board/freescale/lx2160a/lx2160a.c             |  1 +
 configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig |  3 ++
 configs/ls1012afrwy_tfa_defconfig             |  2 +
 configs/ls1012ardb_tfa_SECURE_BOOT_defconfig  |  5 +++
 configs/ls1012ardb_tfa_defconfig              |  2 +
 configs/ls1028ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/ls1028ardb_tfa_defconfig              |  1 +
 configs/ls1043ardb_tfa_SECURE_BOOT_defconfig  |  2 +
 configs/ls1043ardb_tfa_defconfig              |  1 +
 configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig |  2 +
 configs/ls1046afrwy_tfa_defconfig             |  1 +
 configs/ls1046ardb_tfa_SECURE_BOOT_defconfig  |  2 +
 configs/ls1046ardb_tfa_defconfig              |  1 +
 configs/ls1088ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/ls1088ardb_tfa_defconfig              |  1 +
 configs/ls2088ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/ls2088ardb_tfa_defconfig              |  1 +
 configs/lx2160ardb_tfa_SECURE_BOOT_defconfig  |  1 +
 configs/lx2160ardb_tfa_defconfig              |  1 +
 drivers/net/pfe_eth/pfe_firmware.c            | 43 +++++++++++++++----
 include/configs/ls1012afrwy.h                 | 15 +++++++
 include/configs/ls1012ardb.h                  | 19 ++++++--
 include/configs/ls1028a_common.h              |  8 ++++
 include/configs/ls1043a_common.h              |  7 +++
 include/configs/ls1046afrwy.h                 |  8 +++-
 include/configs/ls1046ardb.h                  |  7 +++
 include/configs/ls1088ardb.h                  | 13 ++++++
 include/configs/ls2080ardb.h                  | 13 ++++++
 include/configs/lx2160a_common.h              | 15 ++++++-
 37 files changed, 188 insertions(+), 21 deletions(-)

diff --git a/arch/arm/cpu/armv8/fsl-layerscape/Kconfig b/arch/arm/cpu/armv8/fsl-layerscape/Kconfig
index 42ca990994..9e7d3b841b 100644
--- a/arch/arm/cpu/armv8/fsl-layerscape/Kconfig
+++ b/arch/arm/cpu/armv8/fsl-layerscape/Kconfig
@@ -600,3 +600,20 @@ config HAS_FSL_XHCI_USB
 	help
 	  For some SoC(such as LS1043A and LS1046A), USB and QE-HDLC multiplex use
 	  pins, select it when the pins are assigned to USB.
+
+config POLICY_OTA
+       bool "Support OTA"
+       default n
+       help
+         Enabling this will make a U-Boot binary that supports OTA.
+
+config SYS_PFE_FW_LENGTH
+       bool "PFE firmware length"
+       depends on ARCH_LS1012A && POLICY_OTA
+       default n
+
+config SYS_PFE_FW_ADDR
+       bool "PFE firmware address"
+       depends on ARCH_LS1012A && POLICY_OTA
+       default n
+
diff --git a/arch/arm/cpu/armv8/fsl-layerscape/cpu.c b/arch/arm/cpu/armv8/fsl-layerscape/cpu.c
index bcb365ad6c..dc473bcd9f 100644
--- a/arch/arm/cpu/armv8/fsl-layerscape/cpu.c
+++ b/arch/arm/cpu/armv8/fsl-layerscape/cpu.c
@@ -746,6 +746,9 @@ enum boot_src __get_boot_src(u32 porsr1)
 
 	if (CONFIG_IS_ENABLED(SYS_FSL_ERRATUM_A010539) && !rcw_src)
 		src = BOOT_SOURCE_QSPI_NOR;
+#ifdef CONFIG_POLICY_OTA
+       src = BOOT_SOURCE_SD_MMC;
+#endif
 
 	debug("%s: src 0x%x\n", __func__, src);
 	return src;
diff --git a/board/freescale/ls1012afrdm/ls1012afrdm.c b/board/freescale/ls1012afrdm/ls1012afrdm.c
index 31e41ce169..276c1019cb 100644
--- a/board/freescale/ls1012afrdm/ls1012afrdm.c
+++ b/board/freescale/ls1012afrdm/ls1012afrdm.c
@@ -61,7 +61,7 @@ int checkboard(void)
 		break;
 	}
 #endif
-
+        printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/board/freescale/ls1012ardb/ls1012ardb.c b/board/freescale/ls1012ardb/ls1012ardb.c
index f4aaa71bb6..366f6674d2 100644
--- a/board/freescale/ls1012ardb/ls1012ardb.c
+++ b/board/freescale/ls1012ardb/ls1012ardb.c
@@ -99,6 +99,7 @@ int checkboard(void)
 
 	puts("Board: LS1012A2G5RDB ");
 #endif
+        printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/board/freescale/ls1043ardb/ls1043ardb.c b/board/freescale/ls1043ardb/ls1043ardb.c
index fbd9a2691b..7ed51ed2aa 100644
--- a/board/freescale/ls1043ardb/ls1043ardb.c
+++ b/board/freescale/ls1043ardb/ls1043ardb.c
@@ -180,7 +180,7 @@ int checkboard(void)
 	puts("SERDES Reference Clocks:\n");
 	sd1refclk_sel = CPLD_READ(sd1refclk_sel);
 	printf("SD1_CLK1 = %s, SD1_CLK2 = %s\n", freq[sd1refclk_sel], freq[0]);
-
+        printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/board/freescale/ls1046ardb/ls1046ardb.c b/board/freescale/ls1046ardb/ls1046ardb.c
index 0a73fe859d..ada0a69ca9 100644
--- a/board/freescale/ls1046ardb/ls1046ardb.c
+++ b/board/freescale/ls1046ardb/ls1046ardb.c
@@ -61,7 +61,7 @@ int checkboard(void)
 	puts("SERDES Reference Clocks:\n");
 	sd1refclk_sel = CPLD_READ(sd1refclk_sel);
 	printf("SD1_CLK1 = %s, SD1_CLK2 = %s\n", freq[sd1refclk_sel], freq[0]);
-
+        printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/board/freescale/ls1088a/ls1088a.c b/board/freescale/ls1088a/ls1088a.c
index f1592982a3..bd874ad7d9 100644
--- a/board/freescale/ls1088a/ls1088a.c
+++ b/board/freescale/ls1088a/ls1088a.c
@@ -313,7 +313,7 @@ int checkboard(void)
 	printf("Clock1 = %sMHz ", freq[clock]);
 	clock = (sw >> 0) & 3;
 	printf("Clock2 = %sMHz\n", freq[clock]);
-
+        printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 #endif
diff --git a/board/freescale/ls2080ardb/ls2080ardb.c b/board/freescale/ls2080ardb/ls2080ardb.c
index 6a1b8e3f53..0a50667d98 100644
--- a/board/freescale/ls2080ardb/ls2080ardb.c
+++ b/board/freescale/ls2080ardb/ls2080ardb.c
@@ -132,7 +132,7 @@ int checkboard(void)
 	puts("\nSERDES2 Reference : ");
 	printf("Clock1 = 100MHz ");
 	printf("Clock2 = 100MHz\n");
-
+        printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/board/freescale/lx2160a/lx2160a.c b/board/freescale/lx2160a/lx2160a.c
index e493483c89..73adf987df 100644
--- a/board/freescale/lx2160a/lx2160a.c
+++ b/board/freescale/lx2160a/lx2160a.c
@@ -375,6 +375,7 @@ int checkboard(void)
 	puts("SERDES2 Reference: Clock1 = 100MHz Clock2 = 100MHz\n");
 	puts("SERDES3 Reference: Clock1 = 100MHz Clock2 = 100MHz\n");
 #endif
+	printf("EdgeScale Bootstrap U-Boot\n");
 	return 0;
 }
 
diff --git a/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig b/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig
index c2eb599229..f7ddc6195a 100644
--- a/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1012afrwy_tfa_SECURE_BOOT_defconfig
@@ -27,6 +27,8 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-frwy"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
 CONFIG_SATA_CEVA=y
@@ -58,3 +60,4 @@ CONFIG_RSA_SOFTWARE_EXP=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
 CONFIG_DM_RTC=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1012afrwy_tfa_defconfig b/configs/ls1012afrwy_tfa_defconfig
index 14b1716b03..494b3ba3d5 100644
--- a/configs/ls1012afrwy_tfa_defconfig
+++ b/configs/ls1012afrwy_tfa_defconfig
@@ -27,6 +27,7 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-frwy"
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
@@ -60,3 +61,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
 CONFIG_DM_RTC=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig
index 342fac6083..2d18faca68 100644
--- a/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1012ardb_tfa_SECURE_BOOT_defconfig
@@ -31,6 +31,8 @@ CONFIG_CMD_SETEXPR=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-rdb"
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
 CONFIG_SATA_CEVA=y
@@ -40,6 +42,8 @@ CONFIG_DM_SPI_FLASH=y
 CONFIG_SPI_FLASH=y
 # CONFIG_SPI_FLASH_BAR is not set
 # CONFIG_SPI_FLASH_USE_4K_SECTORS is not set
+CONFIG_FSL_PFE=y
+CONFIG_DM_ETH=y
 CONFIG_E1000=y
 CONFIG_PCI=y
 CONFIG_DM_PCI=y
@@ -60,3 +64,4 @@ CONFIG_RSA_SOFTWARE_EXP=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
 CONFIG_DM_RTC=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1012ardb_tfa_defconfig b/configs/ls1012ardb_tfa_defconfig
index 11e04470c8..159e1db162 100644
--- a/configs/ls1012ardb_tfa_defconfig
+++ b/configs/ls1012ardb_tfa_defconfig
@@ -29,6 +29,7 @@ CONFIG_CMD_USB=y
 CONFIG_CMD_CACHE=y
 CONFIG_OF_CONTROL=y
 CONFIG_DEFAULT_DEVICE_TREE="fsl-ls1012a-rdb"
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_DM=y
@@ -60,3 +61,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
 CONFIG_DM_RTC=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig
index fd3e314dab..19468a1a7f 100644
--- a/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1028ardb_tfa_SECURE_BOOT_defconfig
@@ -78,3 +78,4 @@ CONFIG_WDT_SP805=y
 CONFIG_RSA=y
 CONFIG_OF_LIBFDT_OVERLAY=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1028ardb_tfa_defconfig b/configs/ls1028ardb_tfa_defconfig
index db86521d54..1bb605f116 100644
--- a/configs/ls1028ardb_tfa_defconfig
+++ b/configs/ls1028ardb_tfa_defconfig
@@ -85,3 +85,4 @@ CONFIG_WDT=y
 CONFIG_WDT_SP805=y
 CONFIG_OF_LIBFDT_OVERLAY=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig
index 28fd2f3002..62510176ff 100644
--- a/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1043ardb_tfa_SECURE_BOOT_defconfig
@@ -12,6 +12,7 @@ CONFIG_OF_BOARD_SETUP=y
 CONFIG_BOOTDELAY=10
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 mtdparts=60000000.nor:2m@0x100000(nor_bank0_uboot),40m@0x1100000(nor_bank0_fit),7m(nor_bank0_user),2m@0x4100000(nor_bank4_uboot),40m@0x5100000(nor_bank4_fit),-(nor_bank4_user);7e800000.flash:1m(nand_uboot),1m(nand_uboot_env),20m(nand_fit);spi0.0:1m(uboot),5m(kernel),1m(dtb),9m(file_system)"
+CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500"
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_IMLS=y
 CONFIG_CMD_GPT=y
@@ -56,3 +57,4 @@ CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
 CONFIG_CMD_SETEXPR=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1043ardb_tfa_defconfig b/configs/ls1043ardb_tfa_defconfig
index 4eca972807..bd9263c2ff 100644
--- a/configs/ls1043ardb_tfa_defconfig
+++ b/configs/ls1043ardb_tfa_defconfig
@@ -55,3 +55,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig b/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig
index aa293302f5..c2618d74a6 100644
--- a/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1046afrwy_tfa_SECURE_BOOT_defconfig
@@ -13,6 +13,7 @@ CONFIG_FIT_VERBOSE=y
 CONFIG_OF_BOARD_SETUP=y
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 mtdparts=1550000.spi:1m(rcw),15m(u-boot),48m(kernel.itb);7e800000.flash:16m(nand_uboot),48m(nand_kernel),448m(nand_free)"
+CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500"
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_GPT=y
 CONFIG_CMD_I2C=y
@@ -55,3 +56,4 @@ CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_RSA=y
 CONFIG_CMD_SETEXPR=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046afrwy_tfa_defconfig b/configs/ls1046afrwy_tfa_defconfig
index b7ea92d632..bfb46c9bf0 100644
--- a/configs/ls1046afrwy_tfa_defconfig
+++ b/configs/ls1046afrwy_tfa_defconfig
@@ -60,3 +60,4 @@ CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig
index 4a2cbd27fb..29bc1ec437 100644
--- a/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1046ardb_tfa_SECURE_BOOT_defconfig
@@ -14,6 +14,7 @@ CONFIG_OF_BOARD_SETUP=y
 CONFIG_BOOTDELAY=10
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 mtdparts=1550000.spi-0:1m(rcw),15m(u-boot),48m(kernel.itb);7e800000.flash:16m(nand_uboot),48m(nand_kernel),448m(nand_free)"
+CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500"
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_GPT=y
 CONFIG_CMD_I2C=y
@@ -56,3 +57,4 @@ CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
 CONFIG_CMD_SETEXPR=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1046ardb_tfa_defconfig b/configs/ls1046ardb_tfa_defconfig
index c7a46b1247..9c7b32f9ac 100644
--- a/configs/ls1046ardb_tfa_defconfig
+++ b/configs/ls1046ardb_tfa_defconfig
@@ -56,3 +56,4 @@ CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
 CONFIG_DM_I2C=y
 CONFIG_DM_GPIO=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig b/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig
index 535fb0e6fd..1388d26404 100644
--- a/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls1088ardb_tfa_SECURE_BOOT_defconfig
@@ -17,6 +17,7 @@ CONFIG_SYS_EXTRA_OPTIONS="SYS_FSL_DDR4"
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500 ramdisk_size=0x3000000 default_hugepagesz=2m hugepagesz=2m hugepages=256"
 # CONFIG_USE_BOOTCOMMAND is not set
+CONFIG_POLICY_OTA=y
 CONFIG_MISC_INIT_R=y
 # CONFIG_DISPLAY_BOARDINFO is not set
 CONFIG_DISPLAY_BOARDINFO_LATE=y
diff --git a/configs/ls1088ardb_tfa_defconfig b/configs/ls1088ardb_tfa_defconfig
index 27d7ff7574..f8def0f36e 100644
--- a/configs/ls1088ardb_tfa_defconfig
+++ b/configs/ls1088ardb_tfa_defconfig
@@ -74,3 +74,4 @@ CONFIG_USB_ETHER_ASIX88179=y
 CONFIG_USB_HOST_ETHER=y
 CONFIG_USB_ETHER_RTL8152=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig b/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig
index e691656216..97c8d5e968 100644
--- a/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/ls2088ardb_tfa_SECURE_BOOT_defconfig
@@ -16,6 +16,7 @@ CONFIG_BOOTDELAY=10
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyS1,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0600 ramdisk_size=0x2000000 default_hugepagesz=2m hugepagesz=2m hugepages=256"
 # CONFIG_USE_BOOTCOMMAND is not set
+CONFIG_POLICY_OTA=y
 CONFIG_MISC_INIT_R=y
 CONFIG_CMD_IMLS=y
 CONFIG_CMD_GREPENV=y
diff --git a/configs/ls2088ardb_tfa_defconfig b/configs/ls2088ardb_tfa_defconfig
index 49138d4d9e..8136289e04 100644
--- a/configs/ls2088ardb_tfa_defconfig
+++ b/configs/ls2088ardb_tfa_defconfig
@@ -77,3 +77,4 @@ CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig b/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig
index 7af032d0b0..ae4e6df06a 100644
--- a/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig
+++ b/configs/lx2160ardb_tfa_SECURE_BOOT_defconfig
@@ -16,6 +16,7 @@ CONFIG_OF_STDOUT_VIA_ALIAS=y
 CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyAMA0,115200 root=/dev/ram0 earlycon=pl011,mmio32,0x21c0000 ramdisk_size=0x2000000 default_hugepagesz=1024m hugepagesz=1024m hugepages=2 pci=pcie_bus_perf"
 # CONFIG_USE_BOOTCOMMAND is not set
+CONFIG_POLICY_OTA=y
 CONFIG_CMD_GREPENV=y
 CONFIG_CMD_EEPROM=y
 CONFIG_CMD_GPT=y
diff --git a/configs/lx2160ardb_tfa_defconfig b/configs/lx2160ardb_tfa_defconfig
index c70d1d1671..61ebe6e1bc 100644
--- a/configs/lx2160ardb_tfa_defconfig
+++ b/configs/lx2160ardb_tfa_defconfig
@@ -70,3 +70,4 @@ CONFIG_DM_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_DWC3=y
 CONFIG_EFI_LOADER_BOUNCE_BUFFER=y
+CONFIG_POLICY_OTA=y
diff --git a/drivers/net/pfe_eth/pfe_firmware.c b/drivers/net/pfe_eth/pfe_firmware.c
index adb2d06010..61267a11c3 100644
--- a/drivers/net/pfe_eth/pfe_firmware.c
+++ b/drivers/net/pfe_eth/pfe_firmware.c
@@ -16,9 +16,12 @@
 #include <fsl_validate.h>
 #endif
 
-#define PFE_FIRMEWARE_FIT_CNF_NAME	"config@1"
+#ifdef CONFIG_POLICY_OTA
+#include <malloc.h>
+#include <mmc.h>
+#endif
 
-static const void *pfe_fit_addr = (void *)CONFIG_SYS_LS_PFE_FW_ADDR;
+#define PFE_FIRMEWARE_FIT_CNF_NAME	"config@1"
 
 /*
  * PFE elf firmware loader.
@@ -92,7 +95,7 @@ err:
  * @return 0 on success, a negative value on error
  */
 static int pfe_get_fw(const void **data,
-		      size_t *size, char *fw_name)
+		      size_t *size, char *fw_name, void *pfe_fit_addr)
 {
 	int conf_node_off, fw_node_off;
 	char *conf_node_name = NULL;
@@ -140,7 +143,7 @@ static int pfe_get_fw(const void **data,
  *
  * @return 0 on success, a negative value on error
  */
-static int pfe_fit_check(void)
+static int pfe_fit_check(void *pfe_fit_addr)
 {
 	int ret = 0;
 
@@ -176,20 +179,42 @@ int pfe_firmware_init(void)
 	const void *raw_image_addr;
 	size_t raw_image_size = 0;
 	u8 *pfe_firmware;
-#ifdef CONFIG_CHAIN_OF_TRUST
+#if defined(CONFIG_CHAIN_OF_TRUST) && !defined(CONFIG_POLICY_OTA)
 	uintptr_t pfe_esbc_hdr = 0;
 	uintptr_t pfe_img_addr = 0;
 #endif
 	int ret = 0;
 	int fw_count;
 
-	ret = pfe_fit_check();
+       void *pfe_fw_addr = NULL;
+
+#ifdef CONFIG_POLICY_OTA
+       int dev = CONFIG_SYS_MMC_ENV_DEV;
+
+       printf("\nPFE firmware on SD_MMC\n");
+       pfe_fw_addr = malloc(CONFIG_SYS_PFE_FW_LENGTH);
+       u32 cnt = CONFIG_SYS_PFE_FW_LENGTH / 512;
+       u32 blk = CONFIG_SYS_PFE_FW_ADDR / 512;
+       struct mmc *mmc = find_mmc_device(CONFIG_SYS_MMC_ENV_DEV);
+
+       if (!mmc) {
+               printf("\nMMC cannot find device for ucode\n");
+       } else {
+               printf("\nMMC read: dev # %u, block # %u, count %u ...\n",
+                      dev, blk, cnt);
+               mmc_init(mmc);
+               (void)blk_dread(mmc_get_blk_desc(mmc), blk, cnt, pfe_fw_addr);
+       }
+#else
+       pfe_fw_addr = (void *)CONFIG_SYS_LS_PFE_FW_ADDR;
+#endif
+	ret = pfe_fit_check(pfe_fw_addr);
 	if (ret)
 		goto err;
 
-#ifdef CONFIG_CHAIN_OF_TRUST
+#if defined(CONFIG_CHAIN_OF_TRUST) && !defined(CONFIG_POLICY_OTA)
 	pfe_esbc_hdr = CONFIG_SYS_LS_PFE_ESBC_ADDR;
-	pfe_img_addr = (uintptr_t)pfe_fit_addr;
+	pfe_img_addr = (uintptr_t)pfe_fw_addr;
 	if (fsl_check_boot_mode_secure() != 0) {
 		/*
 		 * In case of failure in validation, fsl_secboot_validate
@@ -214,7 +239,7 @@ int pfe_firmware_init(void)
 		else if (fw_count == 1)
 			pfe_firmware_name = "tmu";
 
-		pfe_get_fw(&raw_image_addr, &raw_image_size, pfe_firmware_name);
+		pfe_get_fw(&raw_image_addr, &raw_image_size, pfe_firmware_name, pfe_fw_addr);
 		pfe_firmware = malloc(raw_image_size);
 		if (!pfe_firmware)
 			return -ENOMEM;
diff --git a/include/configs/ls1012afrwy.h b/include/configs/ls1012afrwy.h
index a2ca326cfc..9115323ac6 100644
--- a/include/configs/ls1012afrwy.h
+++ b/include/configs/ls1012afrwy.h
@@ -23,6 +23,16 @@
 #define CONFIG_SYS_MEMTEST_START	0x80000000
 #define CONFIG_SYS_MEMTEST_END		0x9fffffff
 
+#ifdef CONFIG_TFABOOT
+#define CONFIG_SYS_MMC_ENV_DEV         0
+
+#ifdef CONFIG_POLICY_OTA
+#define CONFIG_SYS_PFE_FW_LENGTH       0x10000
+#define CONFIG_SYS_PFE_FW_ADDR         0x20000
+#endif
+#endif
+
+
 /* ENV */
 #define CONFIG_SYS_FSL_QSPI_BASE	0x40000000
 #define CONFIG_ENV_ADDR			(CONFIG_SYS_FSL_QSPI_BASE + \
@@ -126,8 +136,13 @@
 #undef CONFIG_BOOTCOMMAND
 #ifdef CONFIG_TFABOOT
 #undef QSPI_NOR_BOOTCOMMAND
+#ifdef CONFIG_SECURE_BOOT
+#define QSPI_NOR_BOOTCOMMAND "pfe stop;mmc read 0xa0000000 0x8000 0x17000;"    \
+                       "bootm 0xa0000000;"
+#else
 #define QSPI_NOR_BOOTCOMMAND "pfe stop; run distro_bootcmd; run sd_bootcmd; "\
 			     "env exists secureboot && esbc_halt;"
+#endif
 #else
 #define CONFIG_BOOTCOMMAND "pfe stop; run distro_bootcmd; run sd_bootcmd; "\
 			   "env exists secureboot && esbc_halt;"
diff --git a/include/configs/ls1012ardb.h b/include/configs/ls1012ardb.h
index 39166fea7d..b13c246fbd 100644
--- a/include/configs/ls1012ardb.h
+++ b/include/configs/ls1012ardb.h
@@ -16,11 +16,15 @@
 #define CONFIG_SYS_MEMTEST_START	0x80000000
 #define CONFIG_SYS_MEMTEST_END		0x9fffffff
 
+#ifdef CONFIG_TFABOOT
+#define CONFIG_SYS_MMC_ENV_DEV         0
+
+#ifdef CONFIG_POLICY_OTA
+#define CONFIG_SYS_PFE_FW_LENGTH       0x10000
+#define CONFIG_SYS_PFE_FW_ADDR         0xa00000
+#endif
+#endif
 
-/* ENV */
-#define CONFIG_SYS_FSL_QSPI_BASE	0x40000000
-#define CONFIG_ENV_ADDR			(CONFIG_SYS_FSL_QSPI_BASE + \
-					 CONFIG_ENV_OFFSET)
 /*
  * I2C IO expander
  */
@@ -119,8 +123,15 @@
 #undef CONFIG_BOOTCOMMAND
 #ifdef CONFIG_TFABOOT
 #undef QSPI_NOR_BOOTCOMMAND
+#ifdef CONFIG_SECURE_BOOT
+#define QSPI_NOR_BOOTCOMMAND "pfe stop;mmc read 0xa0000000 0x8000 0x17000;"    \
+                       "mmc read 0x80000000 0x3000 0x1000;"                    \
+                       "esbc_validate 0x80100000;"                             \
+                       "bootm 0xa0000000;"
+#else
 #define QSPI_NOR_BOOTCOMMAND "pfe stop; run distro_bootcmd; run qspi_bootcmd; "\
 			     "env exists secureboot && esbc_halt;"
+#endif
 #else
 #define CONFIG_BOOTCOMMAND "pfe stop; run distro_bootcmd; run qspi_bootcmd; "\
 			   "env exists secureboot && esbc_halt;"
diff --git a/include/configs/ls1028a_common.h b/include/configs/ls1028a_common.h
index 98320e22e9..99dd646e05 100644
--- a/include/configs/ls1028a_common.h
+++ b/include/configs/ls1028a_common.h
@@ -165,9 +165,17 @@
 #define XSPI_NOR_BOOTCOMMAND	\
 	"run xspi_hdploadcmd; run distro_bootcmd; run xspi_bootcmd; " \
 	"env exists secureboot && esbc_halt;;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND \
+       "mmc read 0xa0000000 0x8000 0x17000;"           \
+       "mmc read 0x80000000 0x3000 0x1000;"            \
+       "esbc_validate 0x80100000;"                     \
+       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND	\
 	"run sd_hdploadcmd; run distro_bootcmd;run sd_bootcmd; " \
 	"env exists secureboot && esbc_halt;"
+#endif
 #define SD2_BOOTCOMMAND	\
 	"run emmc_hdploadcmd; run distro_bootcmd;run emmc_bootcmd; " \
 	"env exists secureboot && esbc_halt;"
diff --git a/include/configs/ls1043a_common.h b/include/configs/ls1043a_common.h
index 1670476ec3..1dfcc061d4 100644
--- a/include/configs/ls1043a_common.h
+++ b/include/configs/ls1043a_common.h
@@ -310,8 +310,15 @@
 #ifdef CONFIG_TFABOOT
 #define QSPI_NOR_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND "mmc read 0xa0000000 0x8000 0x17000;"           \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND "run distro_bootcmd; run sd_bootcmd; "  \
 			   "env exists secureboot && esbc_halt;"
+#endif
 #define IFC_NOR_BOOTCOMMAND "run distro_bootcmd; run nor_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
 #define IFC_NAND_BOOTCOMMAND "run distro_bootcmd; run nand_bootcmd; "	\
diff --git a/include/configs/ls1046afrwy.h b/include/configs/ls1046afrwy.h
index 8609ebfecc..545a81b947 100644
--- a/include/configs/ls1046afrwy.h
+++ b/include/configs/ls1046afrwy.h
@@ -131,9 +131,15 @@
 #undef CONFIG_BOOTCOMMAND
 #define QSPI_NOR_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND "mmc read 0xa0000000 0x8000 0x17000;"   \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND "run distro_bootcmd;run sd_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
-
+#endif
 #include <asm/fsl_secure_boot.h>
 
 #endif /* __LS1046AFRWY_H__ */
diff --git a/include/configs/ls1046ardb.h b/include/configs/ls1046ardb.h
index 2d20f15683..a7fed581bd 100644
--- a/include/configs/ls1046ardb.h
+++ b/include/configs/ls1046ardb.h
@@ -215,8 +215,15 @@
 #ifdef CONFIG_TFABOOT
 #define QSPI_NOR_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND "mmc read 0xa0000000 0x8000 0x17000;"   \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND "run distro_bootcmd;run sd_bootcmd; "	\
 			   "env exists secureboot && esbc_halt;"
+#endif
 #else
 #if defined(CONFIG_QSPI_BOOT)
 #define CONFIG_BOOTCOMMAND "run distro_bootcmd; run qspi_bootcmd; "	\
diff --git a/include/configs/ls1088ardb.h b/include/configs/ls1088ardb.h
index 50de658d2e..32624c11a0 100644
--- a/include/configs/ls1088ardb.h
+++ b/include/configs/ls1088ardb.h
@@ -498,6 +498,18 @@
 		"&& fsl_mc lazyapply dpl 0x80001000;"		\
 		"run distro_bootcmd;run qspi_bootcmd;"		\
 		"env exists secureboot && esbc_halt;"
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND                                         \
+               "mmc read 0x80000000 5000 0x800;"               \
+               "mmc read 0x88000000 7000 0x800;"               \
+               "fsl_mc start mc 0x80000000 0x88000000;"        \
+               "mmc read 0x80000000 6800 0x800;"               \
+               "fsl_mc lazyapply dpl 0x80000000;"              \
+               "mmc read 0xa0000000 0x8000 0x17000;"           \
+               "mmc read 0x80000000 0x3000 0x1000;"            \
+               "esbc_validate 0x80100000;"                     \
+               "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND						\
 		"env exists mcinitcmd && mmcinfo; "		\
 		"mmc read 0x80001000 0x6800 0x800; "		\
@@ -507,6 +519,7 @@
 		"&& fsl_mc lazyapply dpl 0x80001000;"		\
 		"run distro_bootcmd;run sd_bootcmd;"		\
 		"env exists secureboot && esbc_halt;"
+#endif
 #else
 #if defined(CONFIG_QSPI_BOOT)
 /* Try to boot an on-QSPI kernel first, then do normal distro boot */
diff --git a/include/configs/ls2080ardb.h b/include/configs/ls2080ardb.h
index ee9b3484dd..7eea2646dd 100644
--- a/include/configs/ls2080ardb.h
+++ b/include/configs/ls2080ardb.h
@@ -524,6 +524,18 @@ unsigned long get_board_sys_clk(void);
 			"run distro_bootcmd;run qspi_bootcmd; "		\
 			"env exists secureboot && esbc_halt;"
 
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND                                                 \
+                       "mmc read 0x80000000 5000 0x800;"               \
+                       "mmc read 0x88000000 7000 0x800;"               \
+                       "fsl_mc start mc 0x80000000 0x88000000;"        \
+                       "mmc read 0x80000000 6800 0x800;"               \
+                       "fsl_mc lazyapply dpl 0x80000000;"              \
+                       "mmc read 0xa0000000 0x8000 0x17000;"           \
+                       "mmc read 0x80000000 0x3000 0x1000;"            \
+                       "esbc_validate 0x80100000;"                     \
+                       "bootm 0xa0000000;"
+#else
 /* Try to boot an on-SD kernel first, then do normal distro boot */
 #define SD_BOOTCOMMAND						\
 			"env exists mcinitcmd && env exists secureboot "\
@@ -535,6 +547,7 @@ unsigned long get_board_sys_clk(void);
 			"run distro_bootcmd;run sd_bootcmd; "		\
 			"env exists secureboot && esbc_halt;"
 
+#endif
 /* Try to boot an on-NOR kernel first, then do normal distro boot */
 #define IFC_NOR_BOOTCOMMAND						\
 			"env exists mcinitcmd && env exists secureboot "\
diff --git a/include/configs/lx2160a_common.h b/include/configs/lx2160a_common.h
index 398b21d3cf..0087b9ab83 100644
--- a/include/configs/lx2160a_common.h
+++ b/include/configs/lx2160a_common.h
@@ -275,7 +275,18 @@ int select_i2c_ch_pca9547_sec(unsigned char ch);
 			"fsl_mc lazyapply dpl 0x20d00000; "		\
 			"run distro_bootcmd;run xspi_bootcmd; "		\
 			"env exists secureboot && esbc_halt;"
-
+#ifdef CONFIG_SECURE_BOOT
+#define SD_BOOTCOMMAND                                         \
+               "mmc read 0x80000000 5000 0x800;"               \
+               "mmc read 0x88000000 7000 0x800;"               \
+               "fsl_mc start mc 0x80000000 0x88000000;"        \
+               "mmc read 0x80000000 6800 0x800;"               \
+               "fsl_mc lazyapply dpl 0x80000000;"              \
+               "mmc read 0xa0000000 0x8000 0x17000;"           \
+               "mmc read 0x80000000 0x3000 0x1000;"            \
+               "esbc_validate 0x80100000;"                     \
+               "bootm 0xa0000000;"
+#else
 #define SD_BOOTCOMMAND						\
 		"env exists mcinitcmd && mmcinfo; "		\
 		"mmc read 0x80d00000 0x6800 0x800; "		\
@@ -285,7 +296,7 @@ int select_i2c_ch_pca9547_sec(unsigned char ch);
 		"&& fsl_mc lazyapply dpl 0x80d00000;"		\
 		"run distro_bootcmd;run sd_bootcmd;"		\
 		"env exists secureboot && esbc_halt;"
-
+#endif
 #define BOOT_TARGET_DEVICES(func) \
 	func(USB, usb, 0) \
 	func(MMC, mmc, 0) \
-- 
2.17.1

